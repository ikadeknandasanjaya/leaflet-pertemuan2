<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tugas 3 - GeoJSON Batas Administratif Bali</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:#f8fafc; color:#0f172a; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    .header { padding: 24px; text-align:center; }
    .header h1 { margin: 0 0 6px 0; font-size: 28px; font-weight: 800; letter-spacing: -0.02em; }
    .header p { margin: 4px 0; color:#475569; }
    #map { height: 70vh; width: 100%; border-radius: 12px; border:1px solid #e2e8f0; }
    .legend { margin-top: 16px; display:grid; grid-template-columns: 1fr; gap: 10px; padding: 16px; }
    .legend-section { background:#f8fafc; border:1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; }
    .legend-title { font-size: 13px; font-weight: 700; color:#0f172a; margin-bottom: 6px; }
    .legend-list { display:flex; flex-wrap: wrap; gap:8px; }
    .legend-item { display:flex; align-items:center; gap:6px; background:#ffffff; border:1px solid #e2e8f0; padding:6px 8px; border-radius: 6px; font-size: 12px; }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border:1px solid #cbd5e1; }
    .footer { text-align:center; color:#64748b; font-size: 12px; padding:16px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card header">
      <h1>Peta Batas Administratif Bali (GeoJSON)</h1>
      <p>Sistem Informasi Geografis — Tugas Praktik: Data Geospasial dalam GeoJSON</p>
      <p style="font-size:13px">Kamis, 02 Oktober 2025 — Menampilkan batas kecamatan/kabupaten dari file GeoJSON</p>
    </div>

    <div class="card" style="padding:16px;">
      <div id="map"></div>
      <div class="legend" id="legend">
        <div class="legend-section">
          <div class="legend-title">Kabupaten/Kota</div>
          <div class="legend-list" id="legend-kab"></div>
        </div>
        <div class="legend-section">
          <div class="legend-title">Kecamatan</div>
          <div class="legend-list" id="legend-kec"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px; padding:16px;">
      <h3 style="margin:0 0 8px 0;">Instruksi Penempatan Data</h3>
      <ol style="margin:0 0 8px 18px; color:#475569;">
        <li>Letakkan file GeoJSON batas per kabupaten/kota di subfolder <code>geojson/</code> (sudah Anda ekstrak).</li>
        <li>Halaman ini otomatis memuat semua file: <code>51.xx_*.geojson</code> untuk kabupaten & kecamatan.</li>
        <li>Jika atribut nama berbeda (mis. <code>WADMKK</code>, <code>WADMKC</code>), sistem akan mencoba mendeteksi otomatis.</li>
      </ol>
      <div class="footer">Sumber data: <a href="https://rkurniawan.blog/2025/05/01/unduh-file-geojson-batas-administrasi-pemekaran-38-provinsi-indonesia/" target="_blank">Artikel unduh GeoJSON 38 Provinsi</a>. Gunakan sesuai lisensi data.</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([-8.4095, 115.1889], 9);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM & CARTO' });

    function hashColor(str) {
      let h = 0; for (let i = 0; i < str.length; i++) { h = (h << 5) - h + str.charCodeAt(i); h |= 0; }
      const r = (h & 0xFF0000) >> 16, g = (h & 0x00FF00) >> 8, b = (h & 0x0000FF);
      return `rgb(${Math.abs(r)%200}, ${Math.abs(g)%200}, ${Math.abs(b)%200})`;
    }

    const kabupatenLayer = L.layerGroup();
    const kecamatanLayer = L.layerGroup();

    const legendKab = document.getElementById('legend-kab');
    const legendKec = document.getElementById('legend-kec');
    function addLegendItem(container, color, label) {
      const item = document.createElement('div'); item.className = 'legend-item';
      const sw = document.createElement('span'); sw.className = 'swatch'; sw.style.background = color;
      const text = document.createElement('span'); text.textContent = label;
      item.appendChild(sw); item.appendChild(text); container.appendChild(item);
    }

    function selectBestNameKey(features, candidates) {
      let bestKey = null, bestUnique = 0;
      for (const key of candidates) {
        const set = new Set();
        for (let i = 0; i < Math.min(features.length, 200); i++) {
          const v = features[i].properties?.[key];
          if (typeof v === 'string' && v.trim()) set.add(v.trim());
        }
        if (set.size > bestUnique) { bestUnique = set.size; bestKey = key; }
      }
      return bestKey || 'name';
    }

    async function loadGeoJSON(url, namePropCandidates, targetGroup, styleMode) {
      try {
        const res = await fetch(url); if (!res.ok) throw new Error('Tidak dapat memuat ' + url);
        const data = await res.json(); if (!data.features || !data.features.length) return;

        const nameKey = selectBestNameKey(data.features, namePropCandidates);

        const layer = L.geoJSON(data, {
          style: function(feat) {
            const nama = feat.properties?.[nameKey] || feat.properties?.name || 'Wilayah';
            const color = hashColor(nama);
            if (styleMode === 'kabupaten') {
              // Kabupaten: outline BERWARNA unik + lebih tebal + dashed halus
              return { color: color, weight: 3, dashArray: '8,4', fillOpacity: 0 };
            }
            // Kecamatan: fill berwarna
            return { color: color, weight: 1, fillColor: color, fillOpacity: 0.28 };
          },
          onEachFeature: function(feat, lyr) {
            const nama = feat.properties?.[nameKey] || feat.properties?.name || 'Wilayah';
            // Coba tampilkan hierarki jika ada
            const kab = feat.properties?.WADMKK || feat.properties?.Kabupaten || feat.properties?.KABUPATEN || ''; 
            const title = styleMode === 'kabupaten' ? 'Kabupaten/Kota' : 'Kecamatan';
            const parentLine = (styleMode === 'kecamatan' && kab) ? `<br><small><i>Kab/Kota: ${kab}</i></small>` : '';
            lyr.bindPopup(`<b>${title}: ${nama}</b>${parentLine}`);
          }
        });
        layer.addTo(targetGroup);

        // Legend contoh
        const shown = new Set();
        const container = styleMode === 'kabupaten' ? legendKab : legendKec;
        data.features.slice(0, 15).forEach(f => {
          const nm = f.properties?.[nameKey] || f.properties?.name || 'Wilayah';
          if (!shown.has(nm)) { shown.add(nm); addLegendItem(container, hashColor(nm), nm); }
        });
      } catch (e) { console.warn(e.message); }
    }

    const daerah = ['51.01_Jembrana','51.02_Tabanan','51.03_Badung','51.04_Gianyar','51.05_Klungkung','51.06_Bangli','51.07_Karangasem','51.08_Buleleng','51.71_Kota_Denpasar'];

    const propKabupaten = ['WADMKK','kabupaten','Kabupaten','KABUPATEN','Kab_Kota','KAB_KOTA','kab_kota','NM_KAB','NAMOBJ','namobj','name'];
    const propKecamatan = ['WADMKC','kecamatan','Kecamatan','KECAMATAN','NM_KEC','NAMOBJ','namobj','name'];

    daerah.forEach(kode => {
      loadGeoJSON(`geojson/${kode}/${kode}.geojson`, propKabupaten, kabupatenLayer, 'kabupaten');
      loadGeoJSON(`geojson/${kode}/${kode.split('_')[0]}_kecamatan.geojson`, propKecamatan, kecamatanLayer, 'kecamatan');
    });

    kabupatenLayer.addTo(map);
    kecamatanLayer.addTo(map);

    L.control.layers({ 'OpenStreetMap': osm, 'Carto Light': cartoLight }, {
      'Batas Kabupaten/Kota (Outline Berwarna)': kabupatenLayer,
      'Batas Kecamatan (Fill Berwarna)': kecamatanLayer
    }, { collapsed: false }).addTo(map);

    setTimeout(() => {
      const all = L.featureGroup([kabupatenLayer, kecamatanLayer]);
      try { map.fitBounds(all.getBounds().pad(0.05)); } catch (_) {}
    }, 1200);
  </script>
</body>
</html>
